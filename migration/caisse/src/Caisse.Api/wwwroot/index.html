<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CA0142 - Gestion de la caisse</title>
    <style>
        /* Style Windows classique - fidele a Magic Unipaas */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'MS Sans Serif', 'Segoe UI', Tahoma, sans-serif;
            font-size: 11px;
            background-color: #808080;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .magic-window {
            background-color: #d4d0c8;
            border: 2px outset #ffffff;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.4);
            width: 960px;
        }

        .title-bar {
            background: linear-gradient(to right, #0a246a, #a6caf0);
            color: white;
            padding: 3px 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 11px;
        }

        .title-bar .title { display: flex; align-items: center; gap: 5px; }
        .title-bar .icon { width: 16px; height: 16px; background: #4a9; border-radius: 2px; }

        .window-controls { display: flex; gap: 2px; }
        .window-controls button {
            width: 16px; height: 14px;
            border: 1px outset #c0c0c0;
            font-size: 9px; cursor: pointer;
            background: #c0c0c0;
        }

        .window-content { padding: 8px; }

        /* Zone info - CA0142 specifique */
        .info-zone {
            background: #ffffcc;
            border: 1px inset #808080;
            padding: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .info-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-user {
            font-weight: bold;
            font-size: 12px;
        }

        .info-coffre {
            color: #0000ff;
            font-size: 11px;
        }

        .info-date {
            font-size: 11px;
        }

        .info-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .etat-caisse {
            padding: 4px 12px;
            font-weight: bold;
            font-size: 12px;
            border: 2px inset #808080;
        }

        .etat-fermee { background: #ff4444; color: white; }
        .etat-ouverte { background: #44ff44; color: black; }
        .etat-bloquee { background: #ffff44; color: black; }

        /* Grille de boutons - layout exact CA0142 */
        .button-grid {
            display: grid;
            grid-template-columns: 200px 1fr 200px 224px 200px;
            gap: 8px;
            margin-bottom: 8px;
        }

        .button-column {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        /* Bouton Magic style */
        .magic-btn {
            height: 22px;
            border: 2px outset #d4d0c8;
            background: linear-gradient(to bottom, #e8e8e8 0%, #c8c8c8 100%);
            font-size: 11px;
            cursor: pointer;
            padding: 0 8px;
            text-align: left;
        }
        .magic-btn:active { border-style: inset; }
        .magic-btn:disabled { color: #808080; cursor: not-allowed; }
        .magic-btn:hover:not(:disabled) { background: linear-gradient(to bottom, #f0f0f0 0%, #d0d0d0 100%); }

        /* Bouton action principal */
        .action-btn {
            height: 22px;
            min-width: 200px;
            border: 2px outset #d4d0c8;
            background: linear-gradient(to bottom, #e8e8e8 0%, #c8c8c8 100%);
            font-size: 11px;
            cursor: pointer;
            padding: 0 16px;
        }
        .action-btn:active { border-style: inset; }
        .action-btn:disabled { color: #808080; cursor: not-allowed; }

        /* Barre d'actions du bas */
        .action-bar {
            display: flex;
            gap: 8px;
            padding-top: 8px;
            border-top: 1px solid #808080;
        }

        /* Status bar */
        .status-bar {
            background: #d4d0c8;
            border-top: 1px solid #808080;
            padding: 2px 8px;
            font-size: 10px;
            display: flex;
            justify-content: space-between;
        }

        .session-info { color: #006600; font-weight: bold; }

        /* Spacer pour alignement vertical */
        .spacer { flex: 1; }
    </style>
</head>
<body>
    <div class="magic-window">
        <div class="title-bar">
            <div class="title">
                <div class="icon"></div>
                <span>CA0142 - Gestion de la caisse</span>
            </div>
            <div class="window-controls">
                <button>_</button>
                <button>□</button>
                <button onclick="quitter()">×</button>
            </div>
        </div>

        <div class="window-content">
            <!-- Zone info - correspond a la capture CA0142 -->
            <div class="info-zone">
                <div class="info-left">
                    <span class="info-user" id="infoUser">D S I O P (21)</span>
                    <span class="info-coffre" id="infoCoffre">Le coffre 2 est ferme</span>
                    <span class="info-date" id="infoDate"></span>
                </div>
                <div class="info-right">
                    <span id="etatCaisse" class="etat-caisse etat-fermee">Fermee</span>
                </div>
            </div>

            <!-- Grille de boutons - positions exactes de Prg_121 -->
            <div class="button-grid">
                <!-- Colonne 1 (X=7) -->
                <div class="button-column">
                    <button class="magic-btn" id="btnRegulTelecollecte" onclick="regulTelecollecte()">Regul. Telecollecte</button>
                    <button class="magic-btn" id="btnTelecollecteTPE" onclick="telecollecteTPE()">Telecollecte TPE</button>
                    <button class="magic-btn" id="btnVisuSessions" onclick="visuSessions()">Visu sessions</button>
                </div>

                <!-- Colonne 2 (X=238) -->
                <div class="button-column">
                    <div class="spacer"></div>
                    <button class="magic-btn" id="btnConsultation" onclick="consultation()">Consultation</button>
                </div>

                <!-- Colonne 3 (X=469-485) - centrale -->
                <div class="button-column">
                    <div class="spacer"></div>
                    <button class="magic-btn" id="btnPointage" onclick="pointageAppRem()" style="display:none;">Pointage Appro/Remise</button>
                    <button class="magic-btn" id="btnDernierTicket" onclick="imprimerDernierTicket()" style="display:none;">Impression du dernier ticket recapitulatif</button>
                </div>

                <!-- Colonne 4 (X=726) - droite -->
                <div class="button-column">
                    <button class="magic-btn session-only" id="btnApproCaisse" onclick="approCaisse()" disabled>Appro caisse</button>
                    <button class="magic-btn session-only" id="btnApproProduits" onclick="approProduits()" disabled>Appro produits</button>
                    <button class="magic-btn session-only" id="btnRemiseCaisse" onclick="remiseCaisse()" disabled>Remise en caisse</button>
                    <button class="magic-btn" id="btnHistoriques" onclick="historiques()" style="display:none;">Historiques</button>
                </div>

                <!-- Colonne 5 vide pour alignement -->
                <div class="button-column"></div>
            </div>

            <!-- Barre d'actions du bas - positions exactes -->
            <div class="action-bar">
                <button class="action-btn" onclick="quitter()">Quitter</button>
                <button class="action-btn" id="btnOuvrirSession" onclick="ouvrirSession()">Ouvrir la session</button>
                <button class="action-btn" id="btnContinuerSession" onclick="continuerSession()" disabled>Continuer la session</button>
                <button class="action-btn" id="btnFermerSession" onclick="fermerSession()" disabled>Fermer la session</button>
            </div>
        </div>

        <div class="status-bar">
            <span id="statusSession" class="session-info">Session: Fermee</span>
            <span id="statusUser">Utilisateur: -</span>
            <span id="statusTerminal">Terminal: -</span>
        </div>
    </div>

    <script>
        // Contexte global - correspond aux parametres Prg_121
        const CONTEXT = {
            societe: 'C',
            utilisateur: 'ANT',
            terminal: '21',
            etatCaisse: 'F', // F=Fermee, O=Ouverte, B=Bloquee
            coffre2Ferme: true,
            sessionActive: null
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', async () => {
            afficherDate();
            afficherContexte();
            await verifierSession();
            await verifierCoffre2();
            mettreAJourBoutons();
        });

        // Afficher la date courante
        function afficherDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('infoDate').textContent = now.toLocaleDateString('fr-FR', options);
        }

        // Afficher le contexte utilisateur
        function afficherContexte() {
            // Format Magic: "D S I O P (21)" = code utilisateur (terminal)
            document.getElementById('infoUser').textContent =
                `${CONTEXT.utilisateur} (${CONTEXT.terminal})`;
            document.getElementById('statusUser').textContent = `Utilisateur: ${CONTEXT.utilisateur}`;
            document.getElementById('statusTerminal').textContent = `Terminal: ${CONTEXT.terminal}`;
        }

        // Verifier l'etat du coffre 2 (sous-tache "Controle COFFRE2" de Prg_121)
        async function verifierCoffre2() {
            try {
                const response = await fetch(`/api/coffre/etat?terminal=${CONTEXT.terminal}`);
                if (response.ok) {
                    const data = await response.json();
                    CONTEXT.coffre2Ferme = data.coffre2Ferme !== false;
                }
            } catch (e) {
                console.log('Coffre API non disponible, mode demo');
            }

            document.getElementById('infoCoffre').textContent =
                CONTEXT.coffre2Ferme ? 'Le coffre 2 est ferme' : 'Le coffre 2 est ouvert';
        }

        // Verifier session active
        async function verifierSession() {
            try {
                const response = await fetch(`/api/sessions?utilisateur=${CONTEXT.utilisateur}&limit=10`);
                if (response.ok) {
                    const sessions = await response.json();
                    const active = sessions.find(s => s.isActive || s.dateFinSession === '00000000');
                    if (active) {
                        CONTEXT.sessionActive = active;
                        CONTEXT.etatCaisse = 'O'; // Ouverte
                        document.getElementById('statusSession').textContent =
                            `Session: Ouverte (${active.chrono})`;
                    } else {
                        CONTEXT.etatCaisse = 'F'; // Fermee
                        document.getElementById('statusSession').textContent = 'Session: Fermee';
                    }
                }
            } catch (e) {
                document.getElementById('statusSession').textContent = 'Session: Erreur connexion';
            }

            mettreAJourEtat();
        }

        // Mettre a jour l'affichage de l'etat
        function mettreAJourEtat() {
            const etatEl = document.getElementById('etatCaisse');
            etatEl.classList.remove('etat-fermee', 'etat-ouverte', 'etat-bloquee');

            switch (CONTEXT.etatCaisse) {
                case 'O':
                    etatEl.textContent = 'Ouverte';
                    etatEl.classList.add('etat-ouverte');
                    break;
                case 'B':
                    etatEl.textContent = 'Bloquee';
                    etatEl.classList.add('etat-bloquee');
                    break;
                default:
                    etatEl.textContent = 'Fermee';
                    etatEl.classList.add('etat-fermee');
            }
        }

        // Mettre a jour les boutons selon l'etat - logique exacte de Prg_121
        function mettreAJourBoutons() {
            const estFermee = CONTEXT.etatCaisse === 'F';
            const estOuverte = CONTEXT.etatCaisse === 'O';
            const estBloquee = CONTEXT.etatCaisse === 'B';

            // Expression 6: {0,3}=MlsTrans('Fermee') - bouton Ouvrir actif si Fermee
            document.getElementById('btnOuvrirSession').disabled = !estFermee;

            // Expression 7: {0,3}=MlsTrans('Ouverte') - boutons Continuer/Fermer actifs si Ouverte
            document.getElementById('btnContinuerSession').disabled = !estOuverte;
            document.getElementById('btnFermerSession').disabled = !estOuverte;

            // Expression 12: {1,2}='O' - boutons Appro visibles si Ouverte
            document.querySelectorAll('.session-only').forEach(btn => {
                btn.disabled = !estOuverte;
            });

            // Historiques visible si param[7]=true (conditionnel)
            // Pour la demo, on le cache
        }

        // Actions des boutons - correspondent aux RaiseEvent de Prg_121

        function regulTelecollecte() {
            // InternalEventID 34 - Regularisation TPE
            alert('Regularisation Telecollecte - A implementer');
        }

        function telecollecteTPE() {
            // InternalEventID 34 - Telecollecte TPE
            alert('Telecollecte TPE - A implementer');
        }

        function visuSessions() {
            // InternalEventID 228 - Visualisation sessions
            window.location.href = 'sessions.html';
        }

        function consultation() {
            // InternalEventID 227 - Consultation
            window.location.href = 'sessions.html?mode=consultation';
        }

        function approCaisse() {
            // InternalEventID 223 - Appro caisse
            alert('Appro caisse - A implementer');
        }

        function approProduits() {
            // InternalEventID 224 - Appro produits
            alert('Appro produits - A implementer');
        }

        function remiseCaisse() {
            // InternalEventID 225 - Remise en caisse
            alert('Remise en caisse - A implementer');
        }

        function historiques() {
            // InternalEventID 226 - Historiques
            window.location.href = 'sessions.html?mode=historique';
        }

        function pointageAppRem() {
            // InternalEventID 34 - Pointage
            alert('Pointage Appro/Remise - A implementer');
        }

        function imprimerDernierTicket() {
            // InternalEventID 221 - Impression dernier ticket
            alert('Impression dernier ticket - A implementer');
        }

        function ouvrirSession() {
            // RaiseEvent vers PublicObject obj=2 (sous-tache ouverture)
            window.location.href = `ouverture-session.html?utilisateur=${CONTEXT.utilisateur}&terminal=${CONTEXT.terminal}`;
        }

        function continuerSession() {
            // Expression 14: MlsTrans('Continuer la session')
            if (CONTEXT.sessionActive) {
                window.location.href = `menu-caisse.html?chrono=${CONTEXT.sessionActive.chrono}`;
            }
        }

        function fermerSession() {
            // InternalEventID 222 - Fermer la session
            if (CONTEXT.sessionActive) {
                window.location.href = `fermeture-session.html?utilisateur=${CONTEXT.utilisateur}&chrono=${CONTEXT.sessionActive.chrono}&terminal=${CONTEXT.terminal}`;
            }
        }

        function quitter() {
            // InternalEventID 219 - Quitter
            if (confirm('Voulez-vous vraiment quitter ?')) {
                window.close();
            }
        }
    </script>
</body>
</html>

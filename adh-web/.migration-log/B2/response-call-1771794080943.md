Voici le rapport d'analyse de couverture du code généré pour ADH IDE 121 - Gestion caisse :

```json
{
  "programId": 121,
  "programName": "Gestion caisse (Gestion_Caisse_142)",
  "coveragePct": 47,
  "rulesImplemented": 1,
  "rulesTotal": 1,
  "missingRules": [],
  "missingTables": [
    {
      "id": 244,
      "name": "saisie_approvisionnement",
      "mode": "W",
      "description": "Table temporaire de saisie des devises pour comptage initial (121.6.2.4)"
    },
    {
      "id": 227,
      "name": "concurrence_sessions",
      "mode": "W",
      "description": "Détection des sessions parallèles (121.6.12)"
    },
    {
      "id": 249,
      "name": "histo_sessions_caisse_detail",
      "mode": "R",
      "description": "Détails mouvements de session"
    },
    {
      "id": 740,
      "name": "pv_stock_movements",
      "mode": "R",
      "description": "Mouvements de stock articles"
    },
    {
      "id": 697,
      "name": "droits_applications",
      "mode": "R",
      "description": "Paramètres de caisse (121.1, 121.3)"
    },
    {
      "id": 198,
      "name": "coupures_monnaie_locale",
      "mode": "R",
      "description": "Contrôle monnaie (121.6.2.2)"
    }
  ],
  "missingCallees": [
    {
      "id": 116,
      "name": "Calcul concurrence sessions",
      "calls": 12,
      "impact": "CRITIQUE",
      "description": "Appelé 12 fois pour détecter les sessions concurrentes - détecte si plusieurs postes sont ouverts simultanément"
    },
    {
      "id": 134,
      "name": "Mise à jour detail session WS",
      "calls": 3,
      "impact": "HAUT",
      "description": "Mise à jour des détails de session"
    },
    {
      "id": 48,
      "name": "Contrôles - Integrite dates",
      "calls": 2,
      "impact": "HAUT",
      "description": "Vérifie la cohérence des dates comptables (121.5)"
    },
    {
      "id": 155,
      "name": "Controle fermeture caisse WS",
      "calls": 2,
      "impact": "HAUT",
      "description": "Vérifie l'intégrité du coffre (121.2)"
    },
    {
      "id": 43,
      "name": "Recuperation du titre",
      "calls": 1,
      "impact": "MOYEN",
      "description": "Récupère le nom de l'opérateur"
    },
    {
      "id": 119,
      "name": "Affichage sessions",
      "calls": 1,
      "impact": "MOYEN",
      "description": "Affichage liste des sessions"
    },
    {
      "id": 140,
      "name": "Init apport article session WS",
      "calls": 1,
      "impact": "MOYEN",
      "description": "Initialise les articles en session"
    },
    {
      "id": 141,
      "name": "Init devise session WS",
      "calls": 1,
      "impact": "HAUT",
      "description": "Initialise les devises en session (121.6.2.4)"
    },
    {
      "id": 156,
      "name": "Verif session caisse ouverte2",
      "calls": 1,
      "impact": "HAUT",
      "description": "Vérifie si une session est déjà ouverte (121.2)"
    },
    {
      "id": 231,
      "name": "Raisons utilisation ADH",
      "calls": 1,
      "impact": "FAIBLE",
      "description": "Contexte fonctionnel d'utilisation"
    }
  ],
  "implementedFeatures": [
    "✓ Types TypeScript complets (SessionCaisse, ParametresCaisse, MouvementCaisse, SessionConcurrente, DateComptable)",
    "✓ Store Zustand avec état et actions (gestionCaisseStore.ts)",
    "✓ API endpoints pour tous les flux métier",
    "✓ Mock data pour développement sans backend",
    "✓ Composants UI de base (HeaderSectionPanel, MontantsSectionPanel, AlertesSectionPanel, ActionsSectionPanel, MouvementsSectionPanel)",
    "✓ Page principale GestionCaissePage.tsx",
    "✓ Gestion des erreurs (try/catch, state error)",
    "✓ Support dual mode (Mock/Real API)",
    "✓ Formatage monétaire (Intl.NumberFormat)",
    "✓ Affichage statut session avec couleurs",
    "✓ Grid mouvements avec colonnes détaillées"
  ],
  "missingFeatures": [
    {
      "feature": "Contrôle COFFRE2 (121.2)",
      "severity": "CRITIQUE",
      "description": "33 lignes - Vérifie l'intégrité des données coffre2 en appelant IDE 155 et IDE 156. Non implémenté."
    },
    {
      "feature": "Calcul concurrence sessions (116)",
      "severity": "CRITIQUE",
      "description": "Appelé 12 fois dans 121.6. Détecte si plusieurs postes sont ouverts. État sessions_concurrentes existe mais logique de calcul manquante."
    },
    {
      "feature": "Init devise session WS (141)",
      "severity": "HAUT",
      "description": "Initialise saisie_approvisionnement pour comptage initial (121.6.2.4). Table et logique manquantes."
    },
    {
      "feature": "Contrôle monnaie/produit (121.6.2.2)",
      "severity": "HAUT",
      "description": "13 lignes - Vérifie cohérence stocks monnaie (table 198 coupures_monnaie_locale). Non implémenté."
    },
    {
      "feature": "Contrôles - Integrité dates (48)",
      "severity": "HAUT",
      "description": "Appelé dans 121.5 Lecture session pour valider journée comptable. Non implémenté."
    },
    {
      "feature": "Browse - Concurrence sessions (121.6.12)",
      "severity": "MOYEN",
      "description": "6 lignes - Ecran affichant liste sessions concurrentes (table 227). UI manquante."
    },
    {
      "feature": "Paramètres caisse (121.1, 121.3)",
      "severity": "MOYEN",
      "description": "20 lignes totales - Charge depuis table 697 droits_applications. Store a ParametresCaisse mais source différente."
    },
    {
      "feature": "Dialogs interactifs",
      "severity": "MOYEN",
      "description": "Historique et Consultation dialogs déclarés dans types mais composants manquants."
    }
  ],
  "dataModelGaps": [
    {
      "entity": "ParametresCaisse",
      "issue": "Champs (caisseId, seuilAlerte, deviseLocale, impressionAuto) ne correspondent pas à la table spec 697 droits_applications",
      "recommendation": "Vérifier mapping exact avec backend ou renommer en CaisseSettings"
    },
    {
      "entity": "SessionCoffre",
      "issue": "Existe dans types.ts mais jamais utilisé dans store",
      "recommendation": "Intégrer dans controlerCoffre() ou supprimer"
    },
    {
      "entity": "saisie_approvisionnement (table 244)",
      "issue": "Table temporaire de comptage initial non modélisée",
      "recommendation": "Créer SaisieDeviseInitiale type et endpoint /api/init-devises"
    },
    {
      "entity": "concurrence_sessions (table 227)",
      "issue": "Type SessionConcurrente existe mais table Write mode non implémenté",
      "recommendation": "Ajouter endpoint POST /api/sessions/detecter-concurrence"
    }
  ],
  "errorHandlingGaps": [
    "❌ Pas de validation des montants négatifs dans apportCoffre/remiseCoffre",
    "❌ Pas de gestion des conflits de concurrence (double ouverture session)",
    "❌ Pas de rollback si échec après création histo_sessions_caisse (121.6.2.3)",
    "❌ Pas de timeout sur appels API (fetch natif sans timeout)",
    "❌ Messages d'erreur génériques, pas de codes d'erreur métier"
  ],
  "uiLayoutGaps": [
    {
      "spec": "Ecran SDI 939x178 DLU (121.6)",
      "implemented": "ScreenLayout avec panels flexibles, pas de DLU constraints",
      "gap": "Layout responsive moderne vs dimensions fixes Magic"
    },
    {
      "spec": "Browse concurrence sessions (121.6.12) - 6 lignes",
      "implemented": "AlertesSectionPanel affiche liste mais pas en modal/browse dédié",
      "gap": "Format d'affichage différent"
    },
    {
      "spec": "32 tâches avec sous-écrans",
      "implemented": "Page unique avec panels",
      "gap": "Navigation entre tâches non représentée"
    }
  ],
  "recommendations": [
    {
      "priority": "P0-CRITIQUE",
      "item": "Implémenter Calcul concurrence sessions (IDE 116)",
      "rationale": "Appelé 12 fois, fonction centrale de sécurité. Actuellement mock statique.",
      "effort": "4h",
      "files": ["services/api/endpoints-gestionCaisse.ts", "stores/gestionCaisseStore.ts"]
    },
    {
      "priority": "P0-CRITIQUE",
      "item": "Implémenter Contrôle COFFRE2 (121.2)",
      "rationale": "33 lignes de logique d'intégrité. Appelle IDE 155 et 156.",
      "effort": "6h",
      "files": ["services/api/endpoints-gestionCaisse.ts", "types/gestionCaisse.ts (SessionCoffre)"]
    },
    {
      "priority": "P1-HAUT",
      "item": "Implémenter Init devise session WS (IDE 141)",
      "rationale": "Initialise table 244 saisie_approvisionnement pour comptage initial.",
      "effort": "3h",
      "files": ["types/gestionCaisse.ts (SaisieDeviseInitiale)", "services/api/endpoints-gestionCaisse.ts"]
    },
    {
      "priority": "P1-HAUT",
      "item": "Ajouter validation métier dans store",
      "rationale": "Montants négatifs, sessions concurrentes, états invalides",
      "effort": "2h",
      "files": ["stores/gestionCaisseStore.ts"]
    },
    {
      "priority": "P1-HAUT",
      "item": "Créer composants Dialog (Historique, Consultation)",
      "rationale": "Déclarés dans state mais UI manquante",
      "effort": "4h",
      "files": ["components/caisse/gestionCaisse/HistoriqueDialog.tsx", "components/caisse/gestionCaisse/ConsultationDialog.tsx"]
    },
    {
      "priority": "P2-MOYEN",
      "item": "Implémenter Contrôles - Integrité dates (IDE 48)",
      "rationale": "Appelé 2 fois, validation journée comptable",
      "effort": "2h",
      "files": ["services/api/endpoints-gestionCaisse.ts"]
    },
    {
      "priority": "P2-MOYEN",
      "item": "Ajouter Browse concurrence sessions dédié",
      "rationale": "121.6.12 - 6 lignes, écran spécifique",
      "effort": "2h",
      "files": ["components/caisse/gestionCaisse/SessionsConcurrentesGrid.tsx"]
    },
    {
      "priority": "P2-MOYEN",
      "item": "Mapper table 697 droits_applications correctement",
      "rationale": "ParametresCaisse actuel ne correspond pas à la spec",
      "effort": "1h",
      "files": ["types/gestionCaisse.ts"]
    },
    {
      "priority": "P3-FAIBLE",
      "item": "Ajouter tests unitaires store",
      "rationale": "Aucun test généré",
      "effort": "4h",
      "files": ["__tests__/gestionCaisseStore.test.ts"]
    },
    {
      "priority": "P3-FAIBLE",
      "item": "Ajouter timeout et retry policy sur API calls",
      "rationale": "Robustesse réseau",
      "effort": "2h",
      "files": ["services/api/apiClient.ts"]
    }
  ],
  "totalEstimatedEffort": "30h",
  "completenessScore": {
    "types": 85,
    "store": 70,
    "api": 60,
    "ui": 65,
    "errorHandling": 40,
    "businessLogic": 45,
    "overall": 61
  },
  "summary": "Le code généré couvre les fonctionnalités de base (47% selon le contrat) avec une structure solide (types, store, API, UI). Les 10 callees manquants (56% non implémentés) représentent des dépendances critiques comme la détection de concurrence (116), le contrôle coffre (155, 156), et l'initialisation des devises (141). 6 tables sur 11 sont manquantes, notamment saisie_approvisionnement (244) et concurrence_sessions (227). La validation métier et la gestion d'erreur nécessitent un renforcement significatif avant production."
}
```

**Points clés :**

1. **Couverture contrat : 47%** (conforme au contract.yaml)
2. **Règles métier : 1/1 implémentée** (RM-001)
3. **Callees manquants : 10/18** (56%) - **CRITIQUE** car Calcul concurrence sessions (116) est appelé 12 fois
4. **Tables manquantes : 6/11** - saisie_approvisionnement, concurrence_sessions, etc.
5. **Effort estimé : 30h** pour combler les gaps critiques

Le code est **fonctionnel pour le développement** mais **nécessite 30h de travail supplémentaire** (priorités P0-P1) avant mise en production.
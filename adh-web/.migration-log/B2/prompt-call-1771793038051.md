Generate a complete Zustand store for the "gestionCaisse" domain.

RULES (MANDATORY):
- Use import aliases: @/ for src root (e.g. @/stores/..., @/types/...)
- NEVER use `any` type - use `unknown` or precise types
- Tailwind v4 classes for styling (no tailwind.config.js)
- Arrow functions everywhere (no function declarations)
- `as const` instead of TypeScript enum
- verbatimModuleSyntax is enabled: use `import type { X }` ONLY for types/interfaces, use `import { X }` for values/consts
- File must be COMPLETE and ready to write - NO placeholders, NO TODOs, NO "// implement here"
- NO comments except for genuinely complex logic
- Output ONLY the code inside a single markdown code block (```typescript ... ``` or ```tsx ... ```)

SHARED INFRASTRUCTURE (use these exact imports):
- Data source toggle: `import { useDataSourceStore } from "@/stores/dataSourceStore"` (has .getState().isRealApi)
- API client: `import { apiClient } from "@/services/api/apiClient"` and `import type { ApiResponse } from "@/services/api/apiClient"`
- Screen layout: `import { ScreenLayout } from "@/components/layout"` (wrapper with sidebar, takes children + className)
- UI components: `import { Button, Dialog, Input } from "@/components/ui"`
- cn utility: `import { cn } from "@/lib/utils"`

STORE REQUIREMENTS:
- Use `create` from zustand (import { create } from "zustand")
- Import types from @/types/gestionCaisse
- Import useDataSourceStore from @/stores/dataSourceStore
- Mock/API branching via useDataSourceStore.getState().isRealApi
- try/catch with `e instanceof Error` for error handling
- Realistic mock data (not lorem ipsum)
- EVERY business rule from the analysis MUST be implemented
- Include reset() action to clear state

TYPES FILE (already generated):
import type { ApiResponse } from "@/services/api/apiClient";

export type SessionStatut = "ouverte" | "fermee" | "cloture_en_cours" | "suspendue";
export type MouvementType = "apport_coffre" | "remise_coffre" | "apport_produit" | "retrait_produit";
export type DeviseCode = string;

export interface SessionCaisse {
  sessionId: number;
  dateOuverture: string;
  dateFermeture: string | null;
  operateurId: number;
  operateurNom: string;
  statut: SessionStatut;
  montantOuverture: number;
  montantFermeture: number | null;
  ecart: number | null;
}

export interface ParametresCaisse {
  caisseId: number;
  seuilAlerte: number;
  deviseLocale: string;
  impressionAuto: boolean;
}

export interface SessionCoffre {
  sessionId: number;
  montantCoffre: number;
  integrite: boolean;
}

export interface MouvementCaisse {
  mouvementId: number;
  sessionId: number;
  type: MouvementType;
  deviseCode: string;
  montant: number;
  dateHeure: string;
}

export interface SessionConcurrente {
  sessionId: number;
  posteId: string;
  operateurNom: string;
  dateOuverture: string;
}

export interface DateComptable {
  date: string;
  valide: boolean;
}

export interface ApportCoffreRequest {
  montant: number;
  deviseCode: string;
}

export interface ApportProduitRequest {
  produitId: number;
  quantite: number;
}

export interface RemiseCoffre Request {
  montant: number;
  deviseCode: string;
}

export interface HistoriqueQueryParams {
  dateDebut?: string;
  dateFin?: string;
  operateurId?: number;
}

export type OuvrirSessionResponse = ApiResponse<SessionCaisse>;
export type FermerSessionResponse = ApiResponse<SessionCaisse>;
export type ApportCoffReResponse = ApiResponse<MouvementCaisse>;
export type ApportProduitResponse = ApiResponse<MouvementCaisse>;
export type RemiseCoffre Response = ApiResponse<MouvementCaisse>;
export type ParametresCaisseResponse = ApiResponse<ParametresCaisse>;
export type SessionActiveResponse = ApiResponse<SessionCaisse | null>;
export type DateComptableResponse = ApiResponse<DateComptable>;
export type SessionsConcurrentesResponse = ApiResponse<SessionConcurrente[]>;
export type HistoriqueResponse = ApiResponse<SessionCaisse[]>;
export type SessionDetailResponse = ApiResponse<SessionCaisse>;
export type MouvementsResponse = ApiResponse<MouvementCaisse[]>;
export type ReimprimerTicketsResponse = ApiResponse<void>;

export interface GestionCaisseState {
  sessionActive: SessionCaisse | null;
  parametres: ParametresCaisse | null;
  sessionsConcurrentes: SessionConcurrente[];
  mouvements: MouvementCaisse[];
  historique: SessionCaisse[];
  dateComptable: DateComptable | null;
  isLoading: boolean;
  error: string | null;
  showHistoriqueDialog: boolean;
  showConsultationDialog: boolean;
  selectedSessionId: number | null;

  chargerParametres: () => Promise<void>;
  chargerSessionActive: () => Promise<void>;
  verifierDateComptable: () => Promise<void>;
  controlerCoffre: () => Promise<void>;
  detecterSessionsConcurrentes: () => Promise<void>;
  ouvrirSession: () => Promise<void>;
  apportCoffre: (montant: number, deviseCode: string) => Promise<void>;
  apportProduit: (produitId: number, quantite: number) => Promise<void>;
  remiseCoffre: (montant: number, deviseCode: string) => Promise<void>;
  fermerSession: () => Promise<void>;
  consulterHistorique: () => Promise<void>;
  consulterSession: (sessionId: number) => Promise<void>;
  reimprimerTickets: (sessionId: number) => Promise<void>;
  setShowHistoriqueDialog: (show: boolean) => void;
  setShowConsultationDialog: (show: boolean) => void;
  setSelectedSessionId: (sessionId: number | null) => void;
  setError: (error: string | null) => void;
}

export const SESSION_STATUT_LABELS = {
  ouverte: "Ouverte",
  fermee: "Fermée",
  cloture_en_cours: "Clôture en cours",
  suspendue: "Suspendue",
} as const;

export const MOUVEMENT_TYPE_LABELS = {
  apport_coffre: "Apport coffre",
  remise_coffre: "Remise coffre",
  apport_produit: "Apport produit",
  retrait_produit: "Retrait produit",
} as const;

export const MOUVEMENT_TYPE_OPTIONS = [
  { value: "apport_coffre" as const, label: MOUVEMENT_TYPE_LABELS.apport_coffre },
  { value: "remise_coffre" as const, label: MOUVEMENT_TYPE_LABELS.remise_coffre },
  { value: "apport_produit" as const, label: MOUVEMENT_TYPE_LABELS.apport_produit },
  { value: "retrait_produit" as const, label: MOUVEMENT_TYPE_LABELS.retrait_produit },
] as const;

export const SESSION_STATUT_OPTIONS = [
  { value: "ouverte" as const, label: SESSION_STATUT_LABELS.ouverte },
  { value: "fermee" as const, label: SESSION_STATUT_LABELS.fermee },
  { value: "cloture_en_cours" as const, label: SESSION_STATUT_LABELS.cloture_en_cours },
  { value: "suspendue" as const, label: SESSION_STATUT_LABELS.suspendue },
] as const;

ANALYSIS DOCUMENT:
{
  "domain": "gestionCaisse",
  "domainPascal": "GestionCaisse",
  "complexity": "HIGH",
  "entities": [
    {
      "name": "SessionCaisse",
      "fields": [
        {
          "name": "sessionId",
          "type": "number",
          "source": "histo_sessions_caisse.session_id",
          "nullable": false
        },
        {
          "name": "dateOuverture",
          "type": "Date",
          "source": "histo_sessions_caisse.date_ouverture",
          "nullable": false
        },
        {
          "name": "dateFermeture",
          "type": "Date",
          "source": "histo_sessions_caisse.date_fermeture",
          "nullable": true
        },
        {
          "name": "operateurId",
          "type": "number",
          "source": "histo_sessions_caisse.operateur_id",
          "nullable": false
        },
        {
          "name": "operateurNom",
          "type": "string",
          "source": "derived from operateur_id",
          "nullable": false
        },
        {
          "name": "statut",
          "type": "string",
          "source": "histo_sessions_caisse.statut",
          "nullable": false
        },
        {
          "name": "montantOuverture",
          "type": "number",
          "source": "histo_sessions_caisse.montant_ouverture",
          "nullable": false
        },
        {
          "name": "montantFermeture",
          "type": "number",
          "source": "histo_sessions_caisse.montant_fermeture",
          "nullable": true
        },
        {
          "name": "ecart",
          "type": "number",
          "source": "calculated: montantFermeture - montantAttendu",
          "nullable": true
        }
      ]
    },
    {
      "name": "ParametresCaisse",
      "fields": [
        {
          "name": "caisseId",
          "type": "number",
          "source": "parametres_caisse.caisse_id",
          "nullable": false
        },
        {
          "name": "seuilAlerte",
          "type": "number",
          "source": "parametres_caisse.seuil_alerte",
          "nullable": false
        },
        {
          "name": "deviseLocale",
          "type": "string",
          "source": "parametres_caisse.devise_locale",
          "nullable": false
        },
        {
          "name": "impressionAuto",
          "type": "boolean",
          "source": "parametres_caisse.impression_auto",
          "nullable": false
        }
      ]
    },
    {
      "name": "SessionCoffre",
      "fields": [
        {
          "name": "sessionId",
          "type": "number",
          "source": "sessions_coffre2.session_id",
          "nullable": false
        },
        {
          "name": "montantCoffre",
          "type": "number",
          "source": "sessions_coffre2.montant_coffre",
          "nullable": false
        },
        {
          "name": "integrite",
          "type": "boolean",
          "source": "derived from IDE 155/156 validation",
          "nullable": false
        }
      ]
    },
    {
      "name": "MouvementCaisse",
      "fields": [
        {
          "name": "mouvementId",
          "type": "number",
          "source": "saisie_approvisionnement.mouvement_id",
          "nullable": false
        },
        {
          "name": "sessionId",
          "type": "number",
          "source": "saisie_approvisionnement.session_id",
          "nullable": false
        },
        {
          "name": "type",
          "type": "string",
          "source": "saisie_approvisionnement.type",
          "nullable": false
        },
        {
          "name": "deviseCode",
          "type": "string",
          "source": "saisie_approvisionnement.devise_code",
          "nullable": false
        },
        {
          "name": "montant",
          "type": "number",
          "source": "saisie_approvisionnement.montant",
          "nullable": false
        },
        {
          "name": "dateHeure",
          "type": "Date",
          "source": "saisie_approvisionnement.date_heure",
          "nullable": false
        }
      ]
    },
    {
      "name": "SessionConcurrente",
      "fields": [
        {
          "name": "sessionId",
          "type": "number",
          "source": "concurrence_sessions.session_id",
          "nullable": false
        },
        {
          "name": "posteId",
          "type": "string",
          "source": "concurrence_sessions.poste_id",
          "nullable": false
        },
        {
          "name": "operateurNom",
          "type": "string",
          "source": "concurrence_sessions.operateur_nom",
          "nullable": false
        },
        {
          "name": "dateOuverture",
          "type": "Date",
          "source": "concurrence_sessions.date_ouverture",
          "nullable": false
        }
      ]
    },
    {
      "name": "DateComptable",
      "fields": [
        {
          "name": "date",
          "type": "Date",
          "source": "date_comptable___dat.date",
          "nullable": false
        },
        {
          "name": "valide",
          "type": "boolean",
          "source": "derived validation",
          "nullable": false
        }
      ]
    }
  ],
  "stateFields": [
    {
      "name": "sessionActive",
      "type": "SessionCaisse | null",
      "default": "null"
    },
    {
      "name": "parametres",
      "type": "ParametresCaisse | null",
      "default": "null"
    },
    {
      "name": "sessionsConcurrentes",
      "type": "SessionConcurrente[]",
      "default": "[]"
    },
    {
      "name": "mouvements",
      "type": "MouvementCaisse[]",
      "default": "[]"
    },
    {
      "name": "historique",
      "type": "SessionCaisse[]",
      "default": "[]"
    },
    {
      "name": "dateComptable",
      "type": "DateComptable | null",
      "default": "null"
    },
    {
      "name": "isLoading",
      "type": "boolean",
      "default": "false"
    },
    {
      "name": "error",
      "type": "string | null",
      "default": "null"
    },
    {
      "name": "showHistoriqueDialog",
      "type": "boolean",
      "default": "false"
    },
    {
      "name": "showConsultationDialog",
      "type": "boolean",
      "default": "false"
    },
    {
      "name": "selectedSessionId",
      "type": "number | null",
      "default": "null"
    }
  ],
  "actions": [
    {
      "name": "chargerParametres",
      "params": [],
      "businessRules": [
        "Charger les parametres de caisse depuis parametres_caisse (table 697)",
        "Valider la configuration de la caisse (seuil, devise, impression)"
      ],
      "returns": "Promise<void>"
    },
    {
      "name": "chargerSessionActive",
      "params": [],
      "businessRules": [
        "Lire histo_sessions_caisse pour la session courante",
        "Determiner l'etat (ouverte, fermee, en cloture)",
        "Appeler IDE 48 pour controler l'integrite des dates"
      ],
      "returns": "Promise<void>"
    },
    {
      "name": "verifierDateComptable",
      "params": [],
      "businessRules": [
        "Lire date_comptable___dat (table 70)",
        "Valider que la journee comptable est ouverte"
      ],
      "returns": "Promise<void>"
    },
    {
      "name": "controlerCoffre",
      "params": [],
      "businessRules": [
        "Verifier l'integrite des donnees sessions_coffre2",
        "Appeler IDE 155 (Controle fermeture caisse WS)",
        "Appeler IDE 156 (Verif session caisse ouverte2)"
      ],
      "returns": "Promise<void>"
    },
    {
      "name": "detecterSessionsConcurrentes",
      "params": [],
      "businessRules": [
        "Appeler IDE 116 (Calcul concurrence sessions) 12 fois",
        "Lire concurrence_sessions (caisse_concurrences)",
        "Alerter si plusieurs postes sont ouverts simultanement"
      ],
      "returns": "Promise<void>"
    },
    {
      "name": "ouvrirSession",
      "params": [],
      "businessRules": [
        "Verifier qu'aucune cloture n'est en cours (reseau_cloture___rec)",
        "Controler coherence stocks monnaie et produit (table 198)",
        "Creer enregistrement dans histo_sessions_caisse (Write)",
        "Creer enregistrement dans sessions_coffre2 (Write)",
        "Initialiser saisie_approvisionnement pour comptage initial",
        "Appeler IDE 122 (Ouverture caisse) pour processus complet",
        "Appeler IDE 141 (Init devise session WS) pour initialisation devises"
      ],
      "returns": "Promise<void>"
    },
    {
      "name": "apportCoffre",
      "params": [
        "montant: number",
        "deviseCode: string"
      ],
      "businessRules": [
        "Appeler IDE 123 (Apport coffre) pour approvisionnement especes",
        "Enregistrer mouvement via IDE 134 (Mise a jour detail session WS)",
        "Imprimer ticket via IDE 139 (Ticket appro remise)"
      ],
      "returns": "Promise<void>"
    },
    {
      "name": "apportProduit",
      "params": [
        "produitId: number",
        "quantite: number"
      ],
      "businessRules": [
        "Appeler IDE 124 (Apport articles) pour approvisionnement articles",
        "Appeler IDE 140 (Init apport article session WS)",
        "Enregistrer mouvement via IDE 134"
      ],
      "returns": "Promise<void>"
    },
    {
      "name": "remiseCoffre",
      "params": [
        "montant: number",
        "deviseCode: string"
      ],
      "businessRules": [
        "Appeler IDE 125 (Remise en caisse) pour retour especes vers coffre",
        "Enregistrer mouvement via IDE 134",
        "RAZ saisie_approvisionnement (Write, Delete)",
        "Imprimer ticket via IDE 139"
      ],
      "returns": "Promise<void>"
    },
    {
      "name": "fermerSession",
      "params": [],
      "businessRules": [
        "Appeler IDE 131 (Fermeture caisse) pour workflow cloture complet",
        "Mettre a jour histo_sessions_caisse en mode Write (statut ferme)",
        "Verifier coherence mouvements coffre (pointage apports/remises)",
        "Calculer ecarts entre attendu et reel",
        "Recalculer totaux sessions ouvertes"
      ],
      "returns": "Promise<void>"
    },
    {
      "name": "consulterHistorique",
      "params": [],
      "businessRules": [
        "Appeler IDE 132 (Historique session) pour ecran consultation",
        "Afficher sessions passees avec filtres"
      ],
      "returns": "Promise<void>"
    },
    {
      "name": "consulterSession",
      "params": [
        "sessionId: number"
      ],
      "businessRules": [
        "Appeler IDE 119 (Affichage sessions) pour detail session",
        "Afficher mouvements, totaux, ecarts"
      ],
      "returns": "Promise<void>"
    },
    {
      "name": "reimprimerTickets",
      "params": [
        "sessionId: number"
      ],
      "businessRules": [
        "Appeler IDE 151 (Reimpression tickets fermeture)",
        "Appeler IDE 139 (Ticket appro remise) pour tickets mouvements"
      ],
      "returns": "Promise<void>"
    }
  ],
  "apiEndpoints": [
    {
      "method": "GET",
      "path": "/api/gestion-caisse/parametres",
      "queryParams": [],
      "response": "ParametresCaisse"
    },
    {
      "method": "GET",
      "path": "/api/gestion-caisse/session-active",
      "queryParams": [],
      "response": "SessionCaisse | null"
    },
    {
      "method": "GET",
      "path": "/api/gestion-caisse/date-comptable",
      "queryParams": [],
      "response": "DateComptable"
    },
    {
      "method": "GET",
      "path": "/api/gestion-caisse/sessions-concurrentes",
      "queryParams": [],
      "response": "SessionConcurrente[]"
    },
    {
      "method": "POST",
      "path": "/api/gestion-caisse/ouvrir-session",
      "queryParams": [],
      "response": "SessionCaisse"
    },
    {
      "method": "POST",
      "path": "/api/gestion-caisse/apport-coffre",
      "queryParams": [
        "montant",
        "deviseCode"
      ],
      "response": "MouvementCaisse"
    },
    {
      "method": "POST",
      "path": "/api/gestion-caisse/apport-produit",
      "queryParams": [
        "produitId",
        "quantite"
      ],
      "response": "MouvementCaisse"
    },
    {
      "method": "POST",
      "path": "/api/gestion-caisse/remise-coffre",
      "queryParams": [
        "montant",
        "deviseCode"
      ],
      "response": "MouvementCaisse"
    },
    {
      "method": "POST",
      "path": "/api/gestion-caisse/fermer-session",
      "queryParams": [],
      "response": "SessionCaisse"
    },
    {
      "method": "GET",
      "path": "/api/gestion-caisse/historique",
      "queryParams": [
        "dateDebut?",
        "dateFin?",
        "operateurId?"
      ],
      "response": "SessionCaisse[]"
    },
    {
      "method": "GET",
      "path": "/api/gestion-caisse/session/{sessionId}",
      "queryParams": [],
      "response": "SessionCaisse"
    },
    {
      "method": "GET",
      "path": "/api/gestion-caisse/mouvements/{sessionId}",
      "queryParams": [],
      "response": "MouvementCaisse[]"
    },
    {
      "method": "POST",
      "path": "/api/gestion-caisse/reimprimer-tickets/{sessionId}",
      "queryParams": [],
      "response": "void"
    }
  ],
  "uiLayout": {
    "type": "dashboard-with-actions",
    "sections": [
      {
        "name": "headerSection",
        "controls": [
          "operateurNom",
          "dateComptable",
          "sessionStatut"
        ]
      },
      {
        "name": "montantsSection",
        "controls": [
          "montantOuverture",
          "montantActuel",
          "montantFermeture",
          "ecart"
        ]
      },
      {
        "name": "alertesSection",
        "controls": [
          "sessionsConcurrentesList",
          "integriteCoffre"
        ]
      },
      {
        "name": "actionsSection",
        "controls": [
          "btnOuvrirSession",
          "btnFermerSession",
          "btnApportCoffre",
          "btnApportProduit",
          "btnRemiseCoffre",
          "btnHistorique",
          "btnConsultation",
          "btnReimprimer"
        ]
      },
      {
        "name": "mouvementsSection",
        "controls": [
          "mouvementsGrid"
        ]
      }
    ]
  },
  "mockData": {
    "count": 5,
    "description": "Mock data includes: 1 active session with 3 currency movements (EUR, USD), 2 concurrent sessions from different terminals, 5 historical closed sessions with varying ecarts, parameters with EUR as local currency and 100 EUR alert threshold, valid accounting date, and integrity checks passing for coffre2"
  },
  "dependencies": {
    "stores": [
      "useSessionStore",
      "useDeviseStore",
      "useOperateurStore"
    ],
    "sharedTypes": [
      "SessionStatut",
      "MouvementType",
      "DeviseCode"
    ],
    "externalApis": [
      "IDE 116 - Calcul concurrence sessions",
      "IDE 43 - Recuperation du titre",
      "IDE 48 - Controles - Integrite dates",
      "IDE 122 - Ouverture caisse",
      "IDE 123 - Apport coffre",
      "IDE 124 - Apport articles",
      "IDE 125 - Remise en caisse",
      "IDE 131 - Fermeture caisse",
      "IDE 132 - Historique session",
      "IDE 119 - Affichage sessions",
      "IDE 134 - Mise a jour detail session WS",
      "IDE 139 - Ticket appro remise",
      "IDE 140 - Init apport article session WS",
      "IDE 141 - Init devise session WS",
      "IDE 151 - Reimpression tickets fermeture",
      "IDE 155 - Controle fermeture caisse WS",
      "IDE 156 - Verif session caisse ouverte2"
    ]
  }
}

SPEC EXCERPT (business rules):
﻿# ADH IDE 121 - Gestion caisse

> **Analyse**: Phases 1-4 2026-02-07 03:50 -> 03:03 (23h12min) | Assemblage 03:03
> **Pipeline**: V7.2 Enrichi
> **Structure**: 4 onglets (Resume | Ecrans | Donnees | Connexions)

<!-- TAB:Resume -->

## 1. FICHE D'IDENTITE

| Attribut | Valeur |
|----------|--------|
| Projet | ADH |
| IDE Position | 121 |
| Nom Programme | Gestion caisse |
| Fichier source | `Prg_121.xml` |
| Dossier IDE | Caisse |
| Taches | 32 (2 ecrans visibles) |
| Tables modifiees | 4 |
| Programmes appeles | 18 |
| Complexite | **MOYENNE** (score 48/100) |

## 2. DESCRIPTION FONCTIONNELLE

**Gestion caisse** (Public Name : `Gestion_Caisse_142`) est l'ecran principal de gestion du point de vente Club Med (ID ecran CA0142). Ce programme MDI orchestre toutes les operations de caisse : ouverture et fermeture de session, approvisionnement en especes et produits, remise au coffre, consultation d'historique et reimpression de tickets. Il comporte 32 taches et modifie 4 tables liees aux sessions. Le programme est accessible depuis [Menu caisse GM - scroll (IDE 163)](ADH-IDE-163.md) et [Fermeture Sessions (IDE 281)](ADH-IDE-281.md).

### Initialisation et parametrage

Au demarrage, le programme charge les parametres de caisse depuis la table `parametres_caisse` (table 697) via les taches 121.1 et 121.3 (8 + 12 lignes). 121.2 "Controle COFFRE2" (33 lignes) verifie l'integrite des donnees du coffre dans `sessions_coffre2` (caisse_session_coffre2) en appelant [Controle fermeture caisse WS (IDE 155)](ADH-IDE-155.md) et [Verif session caisse ouverte2 (IDE 156)](ADH-IDE-156.md). 121.4 lit la date comptable dans `date_comptable___dat` (table 70) pour s'assurer que la journee comptable est valide. 121.5 "Lecture session" (31 lignes) lit la table `histo_sessions_caisse` (caisse_session) pour determiner l'etat courant de la session (ouverte, fermee, en cloture) et appelle [Controles - Integrite dates (IDE 48)](ADH-IDE-48.md).

<details>
<summary>5 taches : 121.1, 121.2, 121.3, 121.4, 121.5</summary>

- **121.1** - Parametres caisse (8 lignes, lit parametres_caisse)
- **121.2** - Controle COFFRE2 (33 lignes, lit sessions_coffre2)
- **121.3** - Parametres caisse (12 lignes, lit parametres_caisse)
- **121.4** - Date comptable (4 lignes, lit date_comptable___dat)
- **121.5** - Lecture session (31 lignes, lit histo_sessions_caisse)

</details>

### Ecran de pilotage

La tache 121.6 "Pilotage" (128 lignes, ecran SDI 939x178 DLU) est l'ecran principal visible par l'operateur (Gestion de la caisse). Il affiche l'etat de la caisse avec les montants courants et propose un menu d'actions : ouvrir/fermer la session, realiser des apports ou remises, consulter l'historique. Cet ecran appelle [Calcul concurrence sessions (IDE 116)](ADH-IDE-116.md) (12 fois) pour detecter les sessions paralleles, [Recuperation du titre (IDE 43)](ADH-IDE-43.md) pour le nom de l'operateur, et [Raisons utilisation ADH (IDE 231)](ADH-IDE-231.md) pour le contexte fonctionnel. 121.6.12 "Browse - Concurrence sessions" (6 lignes, ecran) affiche la liste des sessions concurrentes dans `concurrence_sessions` (caisse_concurrences) pour alerter si plusieurs postes sont ouverts simultanement.

<details>
<summary>2 taches : 121.6, 121.6.12</summary>

- **121.6** - Pilotage (128 lignes, lit table 740, **[ECRAN]**)
- **121.6.12** - Browse - Concurrence sessions (6 lignes, ecrit concurrence_sessions, **[ECRAN]**)

</details>

### Ouverture de session

L'ouverture de session est geree par la sous-tache 121.6.2 (59 lignes) qui verifie d'abord qu'aucune cloture n'est en cours (121.6.2.1 lit `reseau_cloture___rec`, table 23), puis controle la coherence des stocks monnaie et produit (121.6.2.2, 13 lignes, lit table 198). La tache 121.6.2.3 "Creation histo session" (10 lignes) ecrit un nouvel enregistrement dans `histo_sessions_caisse` (caisse_session) en mode Write, et 121.6.2.3.1 cree l'enregistrement coffre2 correspondant dans `sessions_coffre2` (caisse_session_coffre2). 121.6.2.4 initialise la table temporaire de saisie des devises `saisie_approvisionnement` (caisse_saisie_appro_dev) pour le comptage initial des especes. Le programme delegue le processus complet d'ouverture a [Ouverture caisse (IDE 122)](ADH-IDE-122.md) et l'initialisation des devises a [Init devise session WS (IDE 141)](ADH-IDE-141.md).

<details>
<summary>5 taches : 121.6.2, 121.6.2.1, 121.6.2.2, 121.6.2.3, 121.6.2.4</summary>

- **121.6.2** - Ouverture caisse (59 lignes, orchestrateur)
- **121.6.2.1** - Cloture en cours (5 lignes, lit reseau_cloture___rec)
- **121.6.2.2** - Controle monnaie/produit (13 lignes, lit table 198)
- **121.6.2.3** - Creation histo session (10 lignes, ecrit histo_sessions_caisse)
- **121.6.2.4** - init tempo saisie dev (14 lignes, lit saisie_approvisionnement)

</details>

### Approvisionnement et remise au coffre

Ce domaine gere les mouvements de fonds entre la caisse et le coffre. La tache 121.6.4 "Apport coffre" (17 lignes) declenche un approvisionnement en especes depuis le coffre vers la caisse, en appelant [Apport coffre (IDE 123)](ADH-IDE-123.md). 121.6.5 "Apport produit" (16 lignes) gere l'approvisionnement en articles (timbres, cartes...) via [Apport articles (IDE 124)](ADH-IDE-124.md) et [Init apport article session WS (IDE 140)](ADH-IDE-140.md). La tache 121.6.6 "Remise au coffre" (46 lignes) effectue l'operation inverse : retour des especes de la caisse vers le coffre, en appelant [Remise en caisse (IDE 125)](ADH-IDE-125.md). 121.6.6.1 remet a zero la table `saisie_approvisionnement` (Write, Delete) pour preparer la prochaine saisie. Chaque mouvement est enregistre par [Mise a jour detail session WS (IDE 134)](ADH-IDE-134.md) et imprime via [Ticket appro remise (IDE 139)](ADH-IDE-139.md).

<details>
<summary>4 taches : 121.6.4, 121.6.5, 121.6.6, 121.6.6.1</summary>

- **121.6.4** - Apport coffre (17 lignes, orchestrateur)
- **121.6.5** - Apport produit (16 lignes, orchestrateur)
- **121.6.6** - Remise au coffre (46 lignes, orchestrateur)
- **

REFERENCE PATTERN (follow this exact structure):
```typescript
import { create } from 'zustand';
import type {
  ExtraitAccountInfo,
  ExtraitTransaction,
  ExtraitSummary,
  ExtraitPrintFormat,
} from '@/types/extrait';
import { extraitApi } from '@/services/api/endpoints-lot3';
import { useDataSourceStore } from './dataSourceStore';

interface ExtraitState {
  selectedAccount: ExtraitAccountInfo | null;
  transactions: ExtraitTransaction[];
  summary: ExtraitSummary | null;
  searchResults: ExtraitAccountInfo[];
  isSearching: boolean;
  isLoadingExtrait: boolean;
  isPrinting: boolean;
  error: string | null;
}

interface ExtraitActions {
  searchAccount: (societe: string, query: string) => Promise<void>;
  selectAccount: (account: ExtraitAccountInfo) => void;
  loadExtrait: (
    societe: string,
    codeAdherent: number,
    filiation: number,
    dateDebut?: string,
    dateFin?: string,
  ) => Promise<void>;
  printExtrait: (
    societe: string,
    codeAdherent: number,
    filiation: number,
    format: ExtraitPrintFormat,
  ) => Promise<void>;
  reset: () => void;
}

type ExtraitStore = ExtraitState & ExtraitActions;

const MOCK_ACCOUNTS: ExtraitAccountInfo[] = [
  { societe: 'SOC1', codeAdherent: 1001, filiation: 0, nom: 'DUPONT', prenom: 'Jean', statut: 'normal', hasGiftPass: false },
  { societe: 'SOC1', codeAdherent: 1002, filiation: 0, nom: 'MARTIN', prenom: 'Sophie', statut: 'normal', hasGiftPass: true },
  { societe: 'SOC1', codeAdherent: 1003, filiation: 1, nom: 'DURAND', prenom: 'Pierre', statut: 'bloque', hasGiftPass: false },
];

const MOCK_TRANSACTIONS: ExtraitTransaction[] = [
  { id: 1, date: '2026-02-10', heure: '09:15', libelle: 'Achat boutique', debit: 45.50, credit: 0, solde: -45.50, codeService: 'BTQ', codeImputation: 'IMP01', giftPassFlag: false, nbArticles: 3, status: 'debit', numeroPiece: 'VTE-001', modePaiement: 'CB', caissier: 'MARTIN S.' },
  { id: 2, date: '2026-02-10', heure: '14:30', libelle: 'Credit compte', debit: 0, credit: 200, solde: 154.50, codeService: 'CAI', codeImputation: 'IMP02', giftPassFlag: false, status: 'credit', numeroPiece: 'CRD-042', modePaiement: 'Especes', caissier: 'DUPONT J.' },
  { id: 3, date: '2026-02-09', heure: '12:45', libelle: 'Repas restaurant', libelleSupplementaire: 'Menu du jour', debit: 32.00, credit: 0, solde: 122.50, codeService: 'RST', codeImputation: 'IMP03', giftPassFlag: true, nbArticles: 1, status: 'debit', numeroPiece: 'RST-117', modePaiement: 'GiftPass', caissier: 'MARTIN S.' },
  { id: 4, date: '2026-02-08', heure: '16:00', libelle: 'Annulation vente', debit: 0, credit: 15.00, solde: 154.50, codeService: 'BTQ', codeImputation: 'IMP01', giftPassFlag: false, status: 'annule', numeroPiece: 'ANN-003', modePaiement: 'CB', caissier: 'DUPONT J.', commentaire: 'Erreur de saisie' },
  { id: 5, date: '2026-02-08', heure: '10:20', libelle: 'Regularisation solde', debit: 0, credit: 5.00, solde: 139.50, codeService: 'CAI', codeImputation: 'IMP02', giftPassFlag: false, status: 'regularise', numeroPiece: 'REG-007', modePaiement: 'Interne', caissier: 'ADMIN' },
];

const MOCK_SUMMARY: ExtraitSummary = {
  totalDebit: 77.50,
  totalCredit: 220,
  soldeActuel: 142.50,
  nbTransactions: 5,
};

const initialState: ExtraitState = {
  selectedAccount: null,
  transactions: [],
  summary: null,
  searchResults: [],
  isSearching: false,
  isLoadingExtrait: false,
  isPrinting: false,
  error: null,
};

export const useExtraitStore = create<ExtraitStore>()((set) => ({
  ...initialState,

  searchAccount: async (societe, query) => {
    const { isRealApi } = useDataSourceStore.getState();
    set({ isSearching: true, error: null });

    if (!isRealApi) {
      const filtered = MOCK_ACCOUNTS.filter(
        (a) =>
          a.nom.toLowerCase().includes(query.toLowerCase()) ||
          a.prenom.toLowerCase().includes(query.toLowerCase()) ||
          String(a.codeAdherent).includes(query),
      );
      set({ searchResults: filtered, isSearching: false });
      return;
    }

    try {
      const response = await extraitApi.searchAccount(societe, query);
      set({ searchResults: response.data.data ?? [] });
    } catch (e: unknown) {
      const message = e instanceof Error ? e.message : 'Erreur recherche compte';
      set({ searchResults: [], error: message });
    } finally {
      set({ isSearching: false });
    }
  },

  selectAccount: (account) => {
    set({ selectedAccount: account, transactions: [], summary: null, error: null });
  },

  loadExtrait: async (societe, codeAdherent, filiation, dateDebut, dateFin) => {
    const { isRealApi } = useDataSourceStore.getState();
    set({ isLoadingExtrait: true, error: null });

    if (!isRealApi) {
      set({
        transactions: MOCK_TRANSACTIONS,
        summary: MOCK_SUMMARY,
        isLoadingExtrait: false,
      });
      return;
    }

    try {
      const response = await extraitApi.getExtrait(
        societe,
        codeAdherent,
        filiation,
        dateDebut,
        dateFin,
      );
      const data = response.data.data;
      set({
        transactions: data?.transactions ?? [],
        summary: data?.summary ?? null,
      });
    } catch (e: unknown) {
      const message = e instanceof Error ? e.message : 'Erreur chargement extrait';
      set({ transactions: [], summary: null, error: message });
    } finally {
      set({ isLoadingExtrait: false });
    }
  },

  printExtrait: async (societe, codeAdherent, filiation, format) => {
    const { isRealApi } = useDataSourceStore.getState();
    set({ isPrinting: true, error: null });

    if (!isRealApi) {
      set({ isPrinting: false });
      return;
    }

    try {
      await extraitApi.printExtrait({
        societe,
        codeAdherent,
        filiation,
        format,
      });
    } catch (e: unknown) {
      const message = e instanceof Error ? e.message : 'Erreur impression';
      set({ error: message });
    } finally {
      set({ isPrinting: false });
    }
  },

  reset: () => set({ ...initialState }),
}));

```